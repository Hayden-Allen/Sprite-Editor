<!DOCTYPE html>
<html>
  <body>
    <head>
      <title>Sprite Editor</title>
      <style>
        * {
          font-family: Arial;
        }
        *.unselectable {
          -moz-user-select: -moz-none;
          -khtml-user-select: none;
          -webkit-user-select: none;
        }
      </style>
    </head>

    <canvas id = "c" class = "unselectable"></canvas>
    <br>Grid: <input type = "checkbox" id = "grid" checked/>
        Size: <input type = "text" id = "size" min = "1"/>
        Width: <input type = "number" id = "canvasWidth" min = "0"/>
        Height: <input type = "number" id = "canvasHeight" min = "0"/>
        <button id = "clear">Clear</button>
    <br>Variance: <input type = "range" min = "0" max = "255" id = "varianceSlider" value = "0"/>
                  <input type = "number" min = "0" max = "255" id = "varianceNumber" value = "0"/>
        Alpha Variance: <input type = "range" min = "0" max = "255" id = "alphaVariance" value = "0"/>
        <input type = "checkbox" id = "whitespace">Save Whitespace</button>
    <br>Red:   <input type = "range" min = "0" max = "255" value = "0" id ="red"/>
        Green: <input type = "range" min = "0" max = "255" value = "0" id ="green"/>
        Blue:  <input type = "range" min = "0" max = "255" value = "0" id ="blue"/>
        Alpha: <input type = "range" min = "0" max = "255" value = "255" id ="alpha"/>
    <br><img id = "image">

    <script src = "Square.js"></script>
    <script src = "SquareState.js"></script>
    <script src = "Color.js"></script>
    <script>
      let c = document.getElementById("c");
      let hBuffer = 100;
      c.height = window.innerHeight - hBuffer;
      c.width = c.height;
      let ctx = c.getContext("2d");

      let grid = true, saveWhitespace = false;
      let gridImage = new Image();

      let color = new Color(0, 0, 0, 255), variance = 0, alphaVariance = 0;
      let size = Math.round(Math.min(c.width, c.height) / 16);
      let squares = [], undoStack = [], redoStack = [];

      changePixelSize();
      changeCanvasSize(c.width, c.height);
      drawSquares();

      function changeCanvasSize(w, h){
        c.width = w;
        c.height = h;

        let sw = parseInt(c.width / size), sh = parseInt(c.height / size);

        while(squares.length < sh)
          squares.push(new Array(sw).fill(null));
        while(squares.length > sh)
          squares.pop();
        if(squares[0].length < sw)
          for(var i = 0; i < squares.length; i++)
            while(squares[i].length < sw)
              squares[i].push(null);
        else if(squares[0].length > sw)
          for(var i = 0; i < squares.length; i++)
            while(squares[i] > sw)
              squares[i].pop();

        drawGrid();
        drawSquares();
      }
      function changePixelSize(){
        c.height = parseInt((window.innerHeight - hBuffer) / size) * size;
        c.width = c.height;
      }
      function drawGrid(){
        ctx.clearRect(0, 0, c.width, c.height);

        for(var i = 0; i <= c.width; i += size){
          ctx.moveTo(i, 0);
          ctx.lineTo(i, c.height);
          ctx.stroke();
        }
        for(var i = 0; i <= c.height; i += size){
          ctx.moveTo(0, i);
          ctx.lineTo(c.width, i);
          ctx.stroke();
        }
        gridImage.src = c.toDataURL();
        ctx.clearRect(0, 0, c.width, c.height);

        gridImage.onload = function(){
          if(grid)
            ctx.drawImage(gridImage, 0, 0, c.width, c.height);
        }
      }
      function addSquare(x, y, redo){
        if(!redo)
          redoStack = [];

        let sColor = color.copy();
        sColor.setRed(sColor.r + parseInt((Math.random() * variance) - (variance / 2)));
        sColor.setGreen(sColor.g + parseInt((Math.random() * variance) - (variance / 2)));
        sColor.setBlue(sColor.b + parseInt((Math.random() * variance) - (variance / 2)));
        sColor.setAlpha(sColor.a + parseInt((Math.random() * alphaVariance) - (alphaVariance / 2)));

        let previous = squares[y][x];
        let s = new Square(x * size, y * size, size, sColor);

        if(previous == null || !previous.equals(s)){
          if(previous != null){
            let alpha = Math.min(255, previous.color.a + sColor.a);
            s.color.setAlpha(alpha);
          }

          let state = new SquareState(x, y, squares[y][x]);
          if(undoStack.length == 0 || !undoStack[undoStack.length - 1].equals(state))
            undoStack.push(state);

          squares[y][x] = s;
          s.draw();
        }

        if(grid)
          ctx.drawImage(gridImage, 0, 0, c.width, c.height);
      }
      function fill(x, y, replace){
        if(x < 0 || x * size >= c.width || y < 0 || y * size >= c.height)
          return;

        let cur = squares[y][x];
        if((cur == null && replace == null) || (cur != null && cur.color.equalsWithin(replace, variance) && !cur.color.equalsWithin(color, variance))){
          addSquare(x, y);
          fill(x - 1, y, replace);
          fill(x + 1, y, replace);
          fill(x, y - 1, replace);
          fill(x, y + 1, replace);
        }
      }
      function removeSquare(){
        undoStack.push(new SquareState(Mouse.x, Mouse.y, squares[Mouse.y][Mouse.x]));
        squares[Mouse.y][Mouse.x] = null;
        ctx.clearRect(Mouse.x * size, Mouse.y * size, size, size);
      }
      function drawSquares(){
        ctx.clearRect(0, 0, c.width, c.height);

        for(var i = 0; i < squares.length; i++)
          for(var j = 0; j < squares[i].length; j++)
            if(squares[i][j] !== null)
              squares[i][j].draw();

        if(grid)
          ctx.drawImage(gridImage, 0, 0, c.width, c.height);
      }
      function updateCanvas(){
        if(Mouse.x >= 0 && (Mouse.x + 1) * size <= c.width && Mouse.y >= 0 && (Mouse.y + 1) * size <= c.height){
          if(Mouse.button === 0)
            addSquare(Mouse.x, Mouse.y);
          else if(Mouse.button === 2)
            removeSquare();
          if(grid)
            ctx.drawImage(gridImage, 0, 0, c.width, c.height);
        }
      }


      let Mouse = {x: 0, y: 0, button: -1};
      let canvasRect = c.getBoundingClientRect();
      window.onmousemove = function(e){
        if(!line || (line && e.movementX > e.movementY))
          Mouse.x = parseInt(Math.floor((e.clientX - canvasRect.left) / size));
        if(!line || (line && e.movementY > e.movementX))
          Mouse.y = parseInt(Math.floor((e.clientY - canvasRect.top) / size) + Math.floor(window.scrollY / size));
        updateCanvas();
      }
      window.onmousedown = function(e){
        Mouse.button = e.button;
        updateCanvas();
      }
      window.onmouseup = function(e){
        Mouse.button = -1;
      }
      window.oncontextmenu = function(e){return false;}
      window.onblur = function(e){Mouse.button = -1;}

      let line = false;
      window.onkeydown = function(e){
        if(e.keyCode === 192){
          let g = grid;
          if(grid){
            grid = false;
            drawSquares();
          }

          let img = document.getElementById("image");
          img.src = c.toDataURL();

          let xmin = c.width - size, ymin = c.height - size;
          let xmax = 0, ymax = 0;

          if(!saveWhitespace){
            for(var i = 0; i < squares.length; i++){
              for(var j = 0; j < squares[i].length; j++){
                let s = squares[i][j];
                if(s == null)
                  continue;
                xmin = Math.min(s.x, xmin);
                xmax = Math.max(s.x, xmax);
                ymin = Math.min(s.y, ymin);
                ymax = Math.max(s.y, ymax);
              }
            }
          }

          img.onload = function(){
            img.onload = null;

            ctx.clearRect(0, 0, c.width, c.height);

            if(!saveWhitespace){
              let w = c.width, h = c.height;
              c.height = ymax - ymin + size;
              c.width = xmax - xmin + size;

              ctx.drawImage(img, xmin, ymin, xmax - xmin + size, ymax - ymin + size, 0, 0, c.width, c.height);
              img.src = c.toDataURL();

              c.width = w;
              c.height = h;
            }
            else{
              ctx.drawImage(img, 0, 0, c.width, c.height);
              img.src = c.toDataURL();
            }

            ctx.clearRect(0, 0, c.width, c.height);
            grid = g;
            drawSquares();
          }

        }
        else if(e.keyCode === 16)
          line = true;
        else if(e.keyCode === 70){
          fill(Mouse.x, Mouse.y, (squares[Mouse.y][Mouse.x] ? squares[Mouse.y][Mouse.x].color : null));
          drawSquares();
        }
        else if(e.keyCode === 67){
          let s = squares[Mouse.y][Mouse.x];
          if(s != null){
            color = s.color;
            setColorBars(color);
          }
        }
        else if(e.keyCode === 90){

          let s = undoStack.pop();
          if(s != null){
            //console.log(s.square);
            redoStack.push(new SquareState(s.x, s.y, squares[s.y][s.x]));
            squares[s.y][s.x] = s.square;
            drawSquares();
          }
        }
        else if(e.keyCode === 89){
          let s = redoStack.pop();
          if(s != null){
            let c = color;
            color = s.square.color;
            addSquare(s.x, s.y, true);
            color = c;
          }
        }
      }
      window.onkeyup = function(e){
        if(e.keyCode === 16)
          line = false;
      }
      function setColorBars(c){
        document.getElementById("red").value = c.r;
        document.getElementById("green").value = c.g;
        document.getElementById("blue").value = c.b;
        document.getElementById("alpha").value = c.a;
      }

      document.getElementById("grid").onchange = function(){
        grid = !grid;
        drawSquares();
      }
      document.getElementById("size").onchange = function(){
        size = parseInt(document.getElementById("size").value);
        changePixelSize();
      }
      document.getElementById("canvasWidth").onchange = function(){
        changeCanvasSize(parseInt(document.getElementById("canvasWidth").value) * size, c.height);
        drawSquares();
      }
      document.getElementById("canvasHeight").onchange = function(){
        changeCanvasSize(c.width, parseInt(document.getElementById("canvasHeight").value) * size);
      }

      document.getElementById("varianceSlider").onchange = function(){
        variance = parseInt(document.getElementById("varianceSlider").value);
        document.getElementById("varianceNumber").value = variance;
      }
      document.getElementById("varianceNumber").onchange = function(){
        variance = parseInt(document.getElementById("varianceNumber").value);
        document.getElementById("varianceSlider").value = variance;
      }
      document.getElementById("alphaVariance").onchange = function(){
        alphaVariance = parseInt(document.getElementById("alphaVariance").value);
      }
      document.getElementById("whitespace").onclick = function(){
        saveWhitespace = !saveWhitespace
      }
      document.getElementById("clear").onclick = function(){
        for(var i = 0; i < squares.length; i++)
          for(var j = 0; j < squares[i].length; j++)
            squares[i][j] = null;

        drawSquares();
      }
      document.getElementById("red").onchange = function(){
        color.setRed(parseInt(document.getElementById("red").value));
      }
      document.getElementById("green").onchange = function(){
        color.setGreen(parseInt(document.getElementById("green").value));
      }
      document.getElementById("blue").onchange = function(){
        color.setBlue(parseInt(document.getElementById("blue").value));
      }
      document.getElementById("alpha").onchange = function(){
        color.setAlpha(parseInt(document.getElementById("alpha").value));
      }
    </script>
  </body>
</html>
